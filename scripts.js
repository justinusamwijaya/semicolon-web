const LOGO_TEXT_SVG = `<svg width="279" height="48" viewBox="0 0 279 48" fill="none" xmlns="http://www.w3.org/2000/svg">
<path d="M77.7129 16.2918C78.7918 16.2918 79.8708 16.2918 80.9824 16.2918C81.658 17.5504 82.3295 18.8111 83.0003 20.0722C83.1918 20.4289 83.3833 20.7856 83.5806 21.153C83.7637 21.4981 83.9468 21.8432 84.1354 22.1987C84.3045 22.5155 84.4736 22.8322 84.6478 23.1586C85.0445 24.0041 85.2882 24.78 85.478 25.6917C85.7478 25.6917 86.0175 25.6917 86.2954 25.6917C86.3913 25.362 86.4872 25.0322 86.586 24.6924C87.2354 22.9015 88.0963 21.2842 89.003 19.6125C89.1747 19.2922 89.3465 18.9718 89.5234 18.6418C89.9442 17.8576 90.3674 17.0746 90.791 16.2918C91.87 16.2918 92.9489 16.2918 94.0605 16.2918C94.0605 21.4168 94.0605 26.5418 94.0605 31.8221C93.2513 31.8221 92.4421 31.8221 91.6084 31.8221C91.4735 28.5853 91.3387 25.3484 91.1997 22.0135C89.851 24.7109 88.5023 27.4083 87.1128 30.1874C86.3036 30.1874 85.4944 30.1874 84.6606 30.1874C83.4468 27.7597 82.233 25.3321 80.9824 22.8309C80.8645 25.1782 80.8645 25.1782 80.7502 27.5257C80.7347 27.8203 80.7191 28.1149 80.703 28.4185C80.6881 28.7181 80.6731 29.0178 80.6576 29.3265C80.5733 30.1922 80.3975 30.9851 80.165 31.8221C79.3558 31.8221 78.5466 31.8221 77.7129 31.8221C77.7129 26.6971 77.7129 21.5721 77.7129 16.2918Z" fill="white"/>
<path d="M248.954 16.2918C251.815 16.2918 251.815 16.2918 252.639 16.9282C252.853 17.2208 253.068 17.5134 253.288 17.8149C253.53 18.1357 253.772 18.4565 254.02 18.7871C254.383 19.2968 254.383 19.2968 254.752 19.8168C254.999 20.1471 255.245 20.4775 255.499 20.8178C256.779 22.5468 257.977 24.3084 259.171 26.1004C259.306 22.8636 259.441 19.6268 259.58 16.2918C260.524 16.2918 261.468 16.2918 262.441 16.2918C262.441 21.4168 262.441 26.5418 262.441 31.8221C259.58 31.8221 259.58 31.8221 258.522 30.818C258.192 30.3676 257.873 29.91 257.562 29.4466C257.306 29.0897 257.306 29.0897 257.045 28.7255C256.694 28.2343 256.347 27.7402 256.003 27.2435C255.514 26.5392 255.013 25.8459 254.505 25.1553C253.738 24.1128 252.98 23.0638 252.224 22.0135C252.089 25.2504 251.954 28.4872 251.815 31.8221C250.871 31.8221 249.927 31.8221 248.954 31.8221C248.954 26.6971 248.954 21.5721 248.954 16.2918Z" fill="white"/>
<path d="M171.89 16.956C174.091 18.2736 175.362 19.8557 176.003 22.3456C176.395 24.828 175.841 26.7575 174.528 28.8751C173.385 30.3816 172.273 31.2477 170.485 31.8222C167.762 32.0723 164.985 32.3219 162.72 30.5961C160.693 28.5641 159.403 27.0915 159.349 24.1336C159.388 21.8568 159.797 20.4452 161.443 18.7919C164.401 16.1064 168.074 15.2009 171.89 16.956ZM163.538 20.3788C162.461 21.8256 162.218 22.9341 162.312 24.6956C162.593 26.5337 163.272 27.4075 164.764 28.5526C166.32 29.483 167.394 29.4517 169.154 29.2136C170.666 28.8002 171.441 28.0327 172.529 26.9179C173.291 25.3928 173.164 23.6742 172.938 22.0136C172.248 20.6057 171.265 19.7706 169.898 18.9995C167.349 18.3779 165.564 18.7403 163.538 20.3788Z" fill="white"/>
<path d="M233.194 16.7772C235.214 18.2057 236.667 19.6597 237.511 22.0136C237.803 24.4692 237.701 26.4533 236.285 28.5526C234.668 30.4321 233.175 31.6618 230.657 31.9531C227.963 32.0548 225.813 31.8278 223.615 30.1874C221.417 27.8737 220.951 25.989 221.008 22.8501C221.322 20.3266 222.523 18.8691 224.484 17.3392C227.161 15.8843 230.323 15.7855 233.194 16.7772ZM224.688 21.0685C223.882 22.7124 223.673 23.8966 224.024 25.6918C224.758 27.1868 225.41 27.9646 226.757 28.9358C228.552 29.5114 229.977 29.4562 231.789 28.9613C233.194 28.0948 234.163 27.2872 234.65 25.6918C234.837 23.7559 234.845 22.82 233.986 21.0685C232.607 19.508 231.404 18.8492 229.337 18.5908C227.27 18.8492 226.067 19.508 224.688 21.0685Z" fill="white"/>
<path d="M41.1723 16.2455C41.6324 16.2476 42.0926 16.2497 42.5667 16.2519C43.0632 16.2533 43.5598 16.2546 44.0713 16.2559C44.5942 16.2594 45.1171 16.2628 45.6558 16.2663C46.1803 16.2682 46.7047 16.27 47.2451 16.2719C48.5459 16.2767 49.8468 16.2835 51.1476 16.2919C51.1476 17.1011 51.1476 17.9103 51.1476 18.744C48.4502 18.744 45.7529 18.744 42.9738 18.744C42.9738 20.0927 42.9738 21.4414 42.9738 22.8309C45.4014 22.8309 47.829 22.8309 50.3302 22.8309C50.3302 23.6401 50.3302 24.4493 50.3302 25.2831C47.9026 25.2831 45.475 25.2831 42.9738 25.2831C42.9738 26.6318 42.9738 27.9804 42.9738 29.37C45.806 29.37 48.6382 29.37 51.5563 29.37C51.5563 30.1792 51.5563 30.9884 51.5563 31.8221C49.9341 31.8322 48.3119 31.8396 46.6896 31.8446C46.1374 31.8466 45.5851 31.8494 45.0329 31.853C44.2406 31.8579 43.4484 31.86 42.6561 31.862C41.9402 31.8653 41.9402 31.8653 41.2098 31.8685C40.1129 31.8221 40.1129 31.8221 39.7042 31.4134C39.663 30.3285 39.6471 29.2545 39.65 28.1695C39.6496 27.8444 39.6492 27.5194 39.6488 27.1845C39.6485 26.496 39.6493 25.8075 39.651 25.119C39.6532 24.0615 39.651 23.004 39.6484 21.9465C39.6486 21.2792 39.6492 20.6119 39.65 19.9445C39.6491 19.6261 39.6483 19.3077 39.6475 18.9796C39.6592 16.3117 39.6592 16.3117 41.1723 16.2455Z" fill="white"/>
<path d="M27.1624 16.9049C27.7061 17.2084 27.7061 17.2084 28.2607 17.518C28.0148 18.3437 27.7405 19.1614 27.4434 19.9701C27.0388 20.1724 27.0388 20.1724 26.626 20.3788C26.1287 20.1765 25.6313 19.9742 25.1189 19.7658C23.3848 19.0651 22.301 19.1477 20.4956 19.5614C20.4956 20.2358 20.4956 20.9101 20.4956 21.6049C20.7622 21.6792 21.0288 21.7534 21.3034 21.83C26.0897 23.2066 26.0897 23.2066 27.801 24.7467C28.4799 26.1424 28.5325 27.459 28.2607 28.9613C27.3731 30.4196 26.5614 31.1919 24.9912 31.8222C22.0299 32.186 19.251 32.0532 16.8174 30.1874C16.5476 29.7828 16.2779 29.3782 16 28.9613C16.4046 28.287 16.8092 27.6126 17.2261 26.9179C17.4336 27.0311 17.6412 27.1444 17.8551 27.2611C19.8488 28.3103 21.583 29.1089 23.8929 28.8592C24.1204 28.758 24.348 28.6569 24.5825 28.5526C24.7174 28.148 24.8523 27.7434 24.9912 27.3266C23.9917 25.8273 23.4925 25.8063 21.7983 25.3342C19.8011 24.6996 18.4394 24.2214 17.2261 22.4223C16.6709 20.626 16.6483 19.8933 17.507 18.2076C19.8211 15.5183 24.0203 15.5464 27.1624 16.9049Z" fill="white"/>
<path d="M147.445 16.8539C148.416 17.518 148.416 17.518 149.233 18.3354C149.156 19.1527 149.156 19.1527 148.824 19.9701C148.42 20.2399 148.015 20.5096 147.598 20.7875C147.404 20.5936 147.211 20.3998 147.011 20.2C145.49 19.2727 144.053 19.1067 142.285 19.1527C140.679 19.6584 140.039 20.1005 139.041 21.4516C138.472 23.2603 138.419 24.6988 139.016 26.5092C140.236 27.9041 141.099 28.4453 142.873 28.9613C144.585 28.9613 145.644 28.4352 147.19 27.7353C148.135 27.7863 148.135 27.7863 148.824 28.144C149.094 28.5486 149.364 28.9532 149.642 29.37C146.758 31.7731 144.802 32.1437 141.059 31.8222C138.597 30.9715 137.066 29.4712 135.823 27.1989C135.087 24.9139 135.099 23.2717 135.746 20.9663C138.291 16.5918 142.665 15.0406 147.445 16.8539Z" fill="white"/>
<path d="M201.955 16.2918C202.899 16.2918 203.843 16.2918 204.816 16.2918C204.816 20.6076 204.816 24.9234 204.816 29.37C206.974 29.37 209.132 29.37 211.355 29.37C211.355 30.1792 211.355 30.9884 211.355 31.8221C208.253 31.8221 205.151 31.8221 201.955 31.8221C201.955 26.6971 201.955 21.5721 201.955 16.2918Z" fill="white"/>
<path d="M106.729 16.2918C107.674 16.2918 108.618 16.2918 109.59 16.2918C109.59 21.4168 109.59 26.5418 109.59 31.8221C108.646 31.8221 107.702 31.8221 106.729 31.8221C106.729 26.6971 106.729 21.5721 106.729 16.2918Z" fill="white"/>
</svg>
`;

// Utility function to check if an element is in viewport
function isElementInViewport(el, percentVisible = 30) {
  if (!el) return false;
  let rect = el.getBoundingClientRect();
  let windowHeight =
    window.innerHeight || document.documentElement.clientHeight;

  return (
    rect.top <= windowHeight * (1 - percentVisible / 100) &&
    rect.bottom >= windowHeight * (percentVisible / 100)
  );
}

// Navbar animation
function updateNavbar() {
  const navbar = document.getElementById("navbar");
  if (!navbar) return;

  const navSections = document.querySelectorAll(".transparent-nav, .black-nav");
  let currentSection = null;

  if (document.body.scrollTop == 0) {
    navbar.className = "transparent-nav";
  } else {
    navbar.className = "black-nav";
  }

  navSections.forEach((section) => {
    if (isElementInViewport(section)) {
      currentSection = section;
    }
  });

  if (currentSection) {
    if (currentSection.id === "what-we-do-section") {
      let serviceCards = document.querySelectorAll(".service-card");
      let seconds = 10;
      serviceCards.forEach((el) => {
        setTimeout(() => {
          el.className = "service-card scrolled";
        }, seconds);
        seconds += 100;
      });
      const serviceList = document.getElementById("service-list");
      if (serviceList) serviceList.className = "scrolled";
    }
    if (currentSection.id === "how-we-do-it-section") {
      const explanationCard = document.getElementById("explanation-card");
      const mobileCarousel = document.getElementById("mobile-carousel");
      if (explanationCard) explanationCard.className = "scrolled";
      if (mobileCarousel) mobileCarousel.className = "scrolled";
    }
  }
}

// How We Do It section step rotation
let currentStepIndex = 0;
const stepInfo = [
  {
    title: "Planning",
    text: "We identify and understand your business objectives, scope and requirements before creating a project plan.",
    image: "./assets/home-step-planning.png",
  },
  {
    title: "Execution",
    text: "Our team of experts implements the project plan, developing your solution with precision and care.",
    image: "./assets/home-step-execution.png",
  },
  {
    title: "Review",
    text: "We rigorously test and refine the solution to ensure it meets the highest standards of quality and performance.",
    image: "./assets/home-step-review.png",
  },
  {
    title: "Handover",
    text: "We deliver the finished product, providing thorough documentation and support to ensure a smooth transition.",
    image: "./assets/home-step-handover.png",
  },
];

let rotationInterval;
let rotationTimeout;

function startRotation() {
  rotationInterval = setInterval(rotateSteps, 5000);
}

function rotateSteps() {
  updateStep((currentStepIndex + 1) % stepInfo.length);
}

function updateStep(index) {
  const steps = document.querySelectorAll("#steps li");
  if (steps.length === 0) return;

  steps[currentStepIndex].classList.remove("selected");
  currentStepIndex = index;
  steps[currentStepIndex].classList.add("selected");
  updateExplanationCard(currentStepIndex);
}

function updateExplanationCard(index) {
  const explanationCard = document.getElementById("explanation-card");
  const explanationImg = document.getElementById("explanation-img");
  const explanationTitle = document.getElementById("explanation-title");
  const explanationText = document.getElementById("explanation-text");

  if (
    !explanationCard ||
    !explanationImg ||
    !explanationTitle ||
    !explanationText
  )
    return;

  explanationCard.style.opacity = 0;
  explanationImg.style.backgroundImage = `url('${stepInfo[index].image}')`;
  explanationTitle.textContent = stepInfo[index].title;
  explanationText.textContent = stepInfo[index].text;
  explanationCard.style.opacity = 1;
}

// Mobile carousel functionality
let currentIndex = 0;
let carouselInterval;

function initMobileCarousel() {
  const mobileCarousel = document.getElementById("mobile-carousel");
  if (!mobileCarousel) return;

  const carouselItems = mobileCarousel.querySelector(".carousel-items");
  const carouselDots = mobileCarousel.querySelector(".carousel-dots");

  if (!carouselItems || !carouselDots) return;

  // Create carousel items
  stepInfo.forEach((step, index) => {
    const item = document.createElement("div");
    item.className = "carousel-item";
    item.innerHTML = `
      <div id="explanation-img" style="background-image: url('${step.image}')"></div>
      <h2>${step.title}</h2>
      <p>${step.text}</p>
    `;
    carouselItems.appendChild(item);

    // Create dot
    const dot = document.createElement("div");
    dot.className = "dot";
    dot.addEventListener("click", () => {
      goToSlide(index);
      stopCarouselRotation();
      startCarouselRotation();
    });
    carouselDots.appendChild(dot);
  });

  updateCarousel();
  setupTouchListeners();
  startCarouselRotation();
}

function updateCarousel() {
  const carouselItems = document.querySelector(
    "#mobile-carousel .carousel-items"
  );
  if (!carouselItems) return;

  carouselItems.style.transform = `translateX(-${currentIndex * 100}%)`;
  document.querySelectorAll(".dot").forEach((dot, index) => {
    dot.classList.toggle("active", index === currentIndex);
  });
}

function startCarouselRotation(seconds = 5000) {
  carouselInterval = setInterval(() => {
    currentIndex = (currentIndex + 1) % stepInfo.length;
    updateCarousel();
  }, seconds);
}

function stopCarouselRotation() {
  clearInterval(carouselInterval);
}

function goToSlide(index) {
  currentIndex = index;
  updateCarousel();
  stopCarouselRotation();
  startCarouselRotation(10000);
}

function setupTouchListeners() {
  const carouselItems = document.querySelector(
    "#mobile-carousel .carousel-items"
  );
  if (!carouselItems) return;

  let startX, moveX;

  carouselItems.addEventListener("touchstart", (e) => {
    startX = e.touches[0].clientX;
    stopCarouselRotation();
  });

  carouselItems.addEventListener("touchmove", (e) => {
    moveX = e.touches[0].clientX;
    const diff = startX - moveX;
    if (Math.abs(diff) > 5) {
      e.preventDefault();
    }
  });

  carouselItems.addEventListener("touchend", () => {
    const diff = startX - moveX;
    if (diff > 50 && currentIndex < stepInfo.length - 1) {
      goToSlide(currentIndex + 1);
    } else if (diff < -50 && currentIndex > 0) {
      goToSlide(currentIndex - 1);
    } else {
      startCarouselRotation(10000);
    }
  });
}

function toggleMobileMenu() {
  const mobileMenu = document.getElementById("mobile-menu");
  const burgerMenuIcon = document.querySelector("#nav-burger-menu img");

  if (!mobileMenu || !burgerMenuIcon) return;

  mobileMenu.classList.toggle("opened");

  if (mobileMenu.classList.contains("opened")) {
    burgerMenuIcon.src = "./assets/X.svg";
  } else {
    burgerMenuIcon.src = "./assets/list.svg";
  }
}

// Event listeners and initialization
document.addEventListener("DOMContentLoaded", function () {
  // Common functionality for all pages
  window.addEventListener("scroll", updateNavbar);

  const navBurgerMenu = document.getElementById("nav-burger-menu");
  if (navBurgerMenu) {
    navBurgerMenu.addEventListener("click", toggleMobileMenu);
  }

  // Homepage specific functionality
  const stepsContainer = document.getElementById("steps");
  if (stepsContainer) {
    const steps = stepsContainer.querySelectorAll("li");
    steps.forEach((step, index) => {
      step.addEventListener("click", () => {
        clearInterval(rotationInterval);
        clearTimeout(rotationTimeout);
        updateStep(index);
        rotationTimeout = setTimeout(() => {
          startRotation();
        }, 10000);
      });
    });

    // Initialize steps rotation
    steps[0].classList.add("selected");
    updateExplanationCard(0);
    startRotation();
  }

  // Initialize mobile carousel if on mobile
  if (window.innerWidth <= 570) {
    initMobileCarousel();
  }

  // Handle window resize for mobile carousel
  window.addEventListener("resize", () => {
    if (window.innerWidth <= 570) {
      const carouselItems = document.querySelector(
        "#mobile-carousel .carousel-items"
      );
      if (carouselItems && carouselItems.children.length === 0) {
        initMobileCarousel();
      } else {
        updateCarousel();
        stopCarouselRotation();
        startCarouselRotation();
      }
    } else {
      stopCarouselRotation();
    }
  });
});

// Function to add loading screen for banner
function addBannerLoadingScreen() {
  const overlay = document.createElement("div");
  overlay.id = "banner-loading-overlay";
  overlay.style.position = "fixed";
  overlay.style.top = "0";
  overlay.style.left = "0";
  overlay.style.width = "100vw";
  overlay.style.height = "100vh"; // Match the height of your banner
  overlay.style.backgroundColor = "rgba(255, 255, 255, .8)";
  overlay.style.display = "flex";
  overlay.style.flexDirection = "column";
  overlay.style.justifyContent = "center";
  overlay.style.alignItems = "center";
  overlay.style.zIndex = "9998";

  const logo = document.createElement("div");
  logo.style.width = "200px";
  logo.style.height = "30px";
  logo.style.marginBottom = "20px";
  logo.style.backgroundImage = `url("data:image/svg+xml,${encodeURIComponent(
    LOGO_TEXT_SVG
  )}")`;
  logo.style.backgroundSize = "cover";
  logo.style.backgroundPosition = "center";
  logo.style.filter = "invert(1) brightness(0)";

  const spinner = document.createElement("div");
  spinner.style.border = "5px solid #f3f3f3";
  spinner.style.borderTop = "5px solid #3498db";
  spinner.style.borderRadius = "50%";
  spinner.style.width = "50px";
  spinner.style.height = "50px";
  spinner.style.animation = "spin 1s linear infinite";

  overlay.appendChild(logo);
  overlay.appendChild(spinner);
  document.body.appendChild(overlay);

  // Add keyframes for spinner animation if not already added
  if (!document.querySelector("style[data-spinner-style]")) {
    const style = document.createElement("style");
    style.setAttribute("data-spinner-style", "");
    style.textContent = `
      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }
    `;
    document.head.appendChild(style);
  }

  return overlay;
}

// Function to remove banner loading screen
function removeBannerLoadingScreen(overlay) {
  overlay.style.opacity = "0";
  overlay.style.transition = "opacity 0.5s ease-out";
  setTimeout(() => {
    overlay.remove();
  }, 500);
}

// Function to add enhanced shimmering effect to unloaded images
function addEnhancedShimmeringEffect(element) {
  const wrapper = document.createElement("div");
  wrapper.style.position = "relative";
  wrapper.style.width = "100%";
  wrapper.style.height = "100%";
  wrapper.style.backgroundColor = "#e0e0e0"; // Gray background

  const shimmer = document.createElement("div");
  shimmer.classList.add("shimmer-effect");
  shimmer.style.position = "absolute";
  shimmer.style.top = "0";
  shimmer.style.left = "0";
  shimmer.style.width = "100%";
  shimmer.style.height = "100%";
  shimmer.style.backgroundImage = `
    linear-gradient(
      to right,
      rgba(255, 255, 255, 0) 0%,
      rgba(255, 255, 255, 0.5) 50%,
      rgba(255, 255, 255, 0) 100%
    )
  `;
  shimmer.style.backgroundSize = "200% 100%";
  shimmer.style.animation = "shimmer 1.5s infinite";

  wrapper.appendChild(shimmer);

  // Replace the content of the element with the wrapper
  element.innerHTML = "";
  element.appendChild(wrapper);

  // Add keyframes for enhanced shimmer animation if not already added
  if (!document.querySelector("style[data-shimmer-style]")) {
    const style = document.createElement("style");
    style.setAttribute("data-shimmer-style", "");
    style.textContent = `
      @keyframes shimmer {
        0% {
          background-position: -200% 0;
        }
        100% {
          background-position: 200% 0;
        }
      }

      .shimmer-effect {
        pointer-events: none;
      }
    `;
    document.head.appendChild(style);
  }

  return wrapper;
}

// Function to remove shimmering effect and set the loaded image
function setLoadedImage(element, imageUrl) {
  element.style.backgroundImage = `url(${imageUrl})`;
  element.style.backgroundColor = "transparent";
  const shimmerWrapper = element.querySelector("div");
  if (shimmerWrapper) {
    element.removeChild(shimmerWrapper);
  }
}

// Function to handle image loading with shimmering effect
function handleImageLoading(element) {
  const bgImage = window
    .getComputedStyle(element)
    .getPropertyValue("background-image");
  const imageUrl = bgImage.replace(/url\(['"]?(.*?)['"]?\)/i, "$1");

  // Remove any existing background image
  element.style.backgroundImage = "none";

  // Add shimmering effect
  addEnhancedShimmeringEffect(element);

  const img = new Image();
  img.onload = () => {
    setLoadedImage(element, imageUrl);
  };
  img.onerror = () => {
    console.error(`Failed to load image: ${imageUrl}`);
    // Optionally, you can set a placeholder image or leave the shimmer effect
  };
  img.src = imageUrl;
}

// Main function to handle loading and shimmering effects
function handleLoadingEffects() {
  const bannerOverlay = addBannerLoadingScreen();
  const bannerImage = document.querySelector(".hero-banner");

  // Handle banner image loading
  if (bannerImage) {
    handleImageLoading(bannerImage);
    // Remove banner overlay when the image is loaded
    bannerImage.addEventListener("load", () => {
      removeBannerLoadingScreen(bannerOverlay);
    });
  } else {
    removeBannerLoadingScreen(bannerOverlay);
  }

  // Handle "How We Do It" section images
  const howWeDoItSection = document.getElementById("how-we-do-it-section");
  if (howWeDoItSection) {
    const imageElements = howWeDoItSection.querySelectorAll(
      '[id^="explanation-img"]'
    );
    imageElements.forEach((element) => {
      handleImageLoading(element);
    });
  }
}

// Call the function when the DOM is fully loaded
document.addEventListener("DOMContentLoaded", handleLoadingEffects);
